# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do

  desc "Run code analysis"
  lane :analyse do
    gradle(task: "multiModuleDetekt")
  end

  desc "Assemble the DevBlackDebug apk"
  lane :assembleDevBlackDebug do
    gradle(task: ":app:assembleDevBlackDebug")
  end

  desc "Assemble the DevBlackRelease apk"
  lane :assembleDevBlackRelease do
    gradle(task: ":app:assembleDevBlackRelease")
  end

  desc "Assemble the AlphaProdDebug apk"
  lane :assembleAlphaProdDebug do
    gradle(task: ":app:assembleAlphaProdDebug")
  end

  desc "Assemble the AlphaProdRelease apk"
  lane :assembleAlphaProdRelease do
    gradle(task: ":app:assembleAlphaProdRelease")
  end

  desc "Assemble the PlayProdDebug apk"
  lane :assemblePlayProdDebug do
    gradle(task: ":app:assemblePlayProdDebug")
  end

  desc "Assemble the PlayBlackRelease apk"
  lane :assemblePlayBlackRelease do
    gradle(task: ":app:assemblePlayBlackRelease")
  end

  desc "Creates the PlayProdRelease APK"
  lane :assemblePlayProdRelease do
    gradle(task: ":app:assemblePlayProdRelease")
  end

  desc "Creates the PlayProdRelease bundle and APK"
  lane :buildPlayProdRelease do
    gradle(tasks: [":app:bundlePlayProdRelease", ":app:assemblePlayProdRelease -PapkBuild=true"])
  end

  desc "Assemble the androidTest apks"
  lane :assembleDebugAndroidTest do
    gradle(task: "assembleDebugAndroidTest")
  end

  desc "Assemble DevBlackDebug and AndroidTest apks"
  lane :assembleDevBlackDebugWithAndroidTests do
    gradle(tasks: [":app:assembleDevBlackDebug", "assembleDebugAndroidTest", "assembleDevDebugAndroidTest"])
  end

  desc "Run Unit tests"
  lane :unitTests do
    gradle(task: "testDebugUnitTest")
    gradle(task: "testDevDebugUnitTest -x :pass:screenshot-tests:testDevDebugUnitTest")
  end

  desc "Verify screenshot tests"
  lane :verifyScreenshotTests do
    gradle(task: "verifyPaparazziDevDebug")
  end

  desc "Run instrumentation tests"
  lane :instrumentationTests do
    sh("../tools/ci/installFirebase.sh")
    sh("../tools/ci/setupGoogleJson.sh")
    sh("../tools/ci/setupGoogleCloud.sh")
    gradle(task: "runFlank")
  end

  desc "Publish dev build to firebase group"
  lane :deployToFirebaseDevGroup do
    sh("../tools/ci/installFirebase.sh")
    sh("../tools/ci/setupGoogleJson.sh")
    sh("../tools/ci/uploadApkToFirebase.sh devBlack")
  end

  desc "Publish alpha build to firebase group"
  lane :deployToFirebaseAlphaGroup do
    sh("../tools/ci/installFirebase.sh")
    sh("../tools/ci/setupGoogleJson.sh")
    sh("../tools/ci/uploadApkToFirebase.sh alphaProd")
  end

  desc "Publish prod black build to firebase group"
  lane :deployToFirebaseProdGroup do
    sh("../tools/ci/installFirebase.sh")
    sh("../tools/ci/setupGoogleJson.sh")
    sh("../tools/ci/uploadApkToFirebase.sh playBlack")
  end

  desc "Publish internal prod bundle"
  lane :deployToPlayInternal do
     upload_to_play_store(
       json_key: './tmp/play-service-account.json',
       track: 'internal',
       release_status: 'draft',
       aab: './app/build/outputs/bundle/playProdRelease/app-play-prod-release.aab'
     )
  end
end
